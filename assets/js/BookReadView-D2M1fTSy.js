import{d as pe,c as D,a9 as he,f as i,l as be,aa as ke,$ as fe,v as n,A as k,x as e,F as l,D as c,O as L,P as O,L as ge,J as K,ag as me,w as a}from"./vue-2Nd6u6r3.js";import{_ as _e}from"./index-BsYwLi1t.js";import"./tiny-B--Sm0qK.js";const ye={key:0,class:"loading-overlay"},we={class:"book-title"},Ce={class:"toolbar-actions"},Se={class:"sidebar-header"},$e={class:"sidebar-tabs"},xe={class:"sidebar-content"},Be={key:0,class:"chapters-list"},Te=["onClick"],Re={class:"chapter-number"},Ne={class:"chapter-title"},ze={key:1,class:"notes-list"},De={key:0,class:"empty-list"},Me={class:"note-header"},Ee={class:"note-chapter"},Fe={class:"note-selection"},Ie={class:"note-content"},Le={key:2,class:"bookmarks-list"},Oe={key:0,class:"empty-list"},Pe=["onClick"],Ve={class:"bookmark-title"},Ae={class:"offline-options"},We={class:"offline-status"},Xe=["disabled"],qe={class:"chapter-container"},He={class:"chapter-header"},je={class:"chapter-title"},Je={class:"chapter-content"},Ue={key:0,class:"original-text"},Ye={key:1,class:"translation-text"},Ge={key:2,class:"notes-text"},Ke={class:"chapter-navigation"},Qe=["disabled"],Ze={class:"chapter-progress"},et=["disabled"],tt={class:"progress-bar"},st={class:"toolbar-buttons"},ot={class:"button-label"},nt={class:"button-label"},at={key:1,class:"page-hint"},Q=50,lt=pe({__name:"BookReadView",setup(it){const M=he(),$=me(),p=D(()=>Number(M.params.id)),u=D(()=>M.query.chapter?Number(M.query.chapter):1),P=i(!1),V=i(!0),r=i({id:0,title:"",author:"",dynasty:"",historicalSignificance:"",cover:"",description:"",chapters:[]}),E=i(16),g=i(!1),m=i(!0),h=i("chapters"),Z=i(!0),ee=i(!0),x=i(!0),_=i([]),A=i([]),F=i(0),d=i("scroll"),f=i(!1),B=i(!1);let W=0,X=0;const b=D(()=>r.value.chapters.find(s=>s.id===u.value)||r.value.chapters[0]),te={id:1,title:"论语",author:"孔子及其弟子",dynasty:"先秦",historicalSignificance:"《论语》是儒家学派的经典著作之一，由孔子的弟子及其再传弟子编撰而成，记录了孔子及其弟子的言行，集中体现了孔子的思想，是儒家思想的重要经典，对中国传统文化产生了深远影响。",cover:"images/books/lunyu.png",description:"《论语》记录了孔子及其弟子的言行，是儒家思想的重要经典，对中国传统文化产生了深远影响。",chapters:[{id:1,title:"学而第一",content:'子曰："学而时习之，不亦说乎？有朋自远方来，不亦乐乎？人不知而不愠，不亦君子乎？"',translation:'孔子说："学习知识并且不断复习，不也是很愉快的事情吗？有朋友从远方来访，不也是很令人高兴的事情吗？别人不了解我，我却不恼怒，不也是有修养的人吗？"',notes:'这是《论语》开篇的第一章，表达了孔子对学习的态度。"说"通"悦"，意为高兴、愉快。"有朋自远方来"强调了友谊的重要性。"人不知而不愠"表现了孔子的宽容胸襟和内心的平静。'},{id:2,title:"为政第二",content:'子曰："为政以德，譬如北辰，居其所而众星共之。"',translation:'孔子说："以德行来治理政事，就如同北极星那样，自己处在那个位置上不动，而群星都环绕着它。"',notes:"这段话阐述了孔子的德治思想，认为统治者应以道德来治理国家，而不是仅靠刑罚。北辰即北极星，古代被视为天空中心，众星围绕，比喻君主处于中心位置，用德行感化众人。"},{id:3,title:"八佾第三",content:'孔子谓季氏："八佾舞于庭，是可忍也，孰不可忍也？"',translation:'孔子评论季氏说："季氏在家庭里使用八排舞者表演舞蹈，这样的僭越如果可以容忍，那么什么事情不可以容忍呢？"',notes:"八佾舞是天子的乐舞规格，每队八人，八队共六十四人。季氏是鲁国大夫，僭越使用了天子的礼仪规格，孔子对此表示批评，体现了孔子对礼制的重视。"},{id:4,title:"里仁第四",content:'子曰："里仁为美。择不处仁，焉得知？"',translation:'孔子说："选择仁德的环境来居住才是美好的。如果选择不住在仁德的环境里，怎么能算有智慧呢？"',notes:'这段话强调了环境对人的影响，以及选择良好环境的重要性。"里"指居住的地方，引申为环境。"仁"是孔子思想的核心概念，包含仁爱、善良等美德。'},{id:5,title:"公冶长第五",content:'子谓公冶长："可妻也，虽在缧绁之中，非其罪也。"以其子妻之。',translation:'孔子评论公冶长说："他是可以把女儿嫁给他的人，即使他被关在监狱里，那也不是因为他犯了罪。"于是把自己的女儿嫁给了他的儿子。',notes:'公冶长是鲁国人，孔子的学生。"缧绁"指捆绑囚犯的绳索，引申为监狱。这句话体现了孔子注重人的品德而非外在处境的思想。'}]},T=()=>"serviceWorker"in navigator,q=async s=>{if(!T())return!1;try{return(await(await caches.open("books-cache")).keys()).some(y=>y.url.includes(`book-${s}`))}catch(t){return console.error("检查缓存失败:",t),!1}},se=async()=>{if(!T()){alert("您的浏览器不支持离线阅读功能");return}try{B.value=!0;const s=[`/api/books/${p.value}`,r.value.cover],t=await caches.open("books-cache"),v=JSON.stringify(r.value),y=new Blob([v],{type:"application/json"}),N=new Response(y);await t.put(`/book-${p.value}`,N),await Promise.all(s.map(S=>fetch(S).then(o=>t.put(S,o)))),f.value=!0,alert("书籍已缓存，可以离线阅读")}catch(s){console.error("缓存书籍失败:",s),alert("缓存书籍失败，请重试")}finally{B.value=!1}},oe=async()=>{if(T())try{await(await caches.open("books-cache")).delete(`/book-${p.value}`),f.value=!1,alert("离线缓存已删除")}catch(s){console.error("删除缓存失败:",s),alert("删除缓存失败，请重试")}},ct=async()=>{if(!T())return null;try{const t=await(await caches.open("books-cache")).match(`/book-${p.value}`);return t?await t.json():null}catch(s){return console.error("从缓存获取数据失败:",s),null}},ne=async()=>{x.value=!0;try{const s=await q(p.value);f.value=s,setTimeout(async()=>{p.value===1?r.value=te:$.push("/books"),x.value=!1},500)}catch(s){console.error("获取书籍数据失败:",s),x.value=!1,$.push("/books")}},ae=()=>{d.value=d.value==="scroll"?"page":"scroll"},H=()=>{const s=r.value.chapters,t=s.findIndex(v=>v.id===u.value);t>0&&R(s[t-1].id)},j=()=>{const s=r.value.chapters,t=s.findIndex(v=>v.id===u.value);t<s.length-1&&R(s[t+1].id)},le=s=>{W=s.changedTouches[0].screenX},ie=s=>{X=s.changedTouches[0].screenX,ce()},ce=()=>{if(d.value!=="page")return;const s=X-W;s>Q?H():s<-Q&&j()},J=()=>{if(d.value==="scroll"){const s=window.scrollY,t=document.body.scrollHeight-window.innerHeight;F.value=Math.round(s/t*100)}},I=()=>{P.value=window.innerWidth<=768},R=s=>{$.push({path:`/book/read/${p.value}`,query:{chapter:s.toString()}})},U=s=>{const t=E.value+s;t>=12&&t<=24&&(E.value=t)},re=()=>{g.value=!g.value},Y=()=>{m.value=!m.value},ue=s=>{const t=_.value.indexOf(s);t>-1?_.value.splice(t,1):_.value.push(s)},G=D(()=>_.value.includes(u.value)),C=i(!1),de=()=>{var s;C.value=!C.value,C.value?console.log("开始朗读:",(s=b.value)==null?void 0:s.content):console.log("停止朗读")},ve=()=>{$.push(`/book/${p.value}`)};return be(async()=>{ne();const s=await q(p.value);f.value=s,window.addEventListener("scroll",J),I(),window.addEventListener("resize",I),window.innerWidth<768&&(d.value="page")}),ke(()=>{window.removeEventListener("scroll",J),window.removeEventListener("resize",I)}),fe(u,()=>{window.scrollTo(0,0),F.value=0}),(s,t)=>{var v,y,N,S;return a(),n("div",{class:c(["book-read-view",{"dark-mode":g.value,"mobile-view":P.value,"page-mode":d.value==="page"}])},[x.value?(a(),n("div",ye,t[6]||(t[6]=[e("div",{class:"loading-spinner"},null,-1),e("p",null,"加载中...",-1)]))):k("",!0),e("div",{class:c(["top-toolbar",{"toolbar-hidden":!V.value}])},[e("button",{class:"back-button",onClick:ve},t[7]||(t[7]=[e("span",{class:"icon-back"},null,-1)])),e("h1",we,l(r.value.title),1),e("div",Ce,[e("button",{class:"action-button",onClick:t[0]||(t[0]=o=>ue(u.value))},[e("span",{class:c(["icon",{"icon-bookmark-filled":G.value,"icon-bookmark":!G.value}])},null,2)]),e("button",{class:"action-button",onClick:Y},[e("span",{class:c(["icon",{"icon-menu":!m.value,"icon-close":m.value}])},null,2)])])],2),e("div",{class:c(["sidebar",{"sidebar-open":m.value}])},[e("div",Se,[e("h2",null,l(r.value.title),1),e("button",{class:"close-button",onClick:Y},t[8]||(t[8]=[e("span",{class:"icon-close"},null,-1)]))]),e("div",$e,[e("button",{class:c(["tab-button",{active:h.value==="chapters"}]),onClick:t[1]||(t[1]=o=>h.value="chapters")}," 目录 ",2),e("button",{class:c(["tab-button",{active:h.value==="notes"}]),onClick:t[2]||(t[2]=o=>h.value="notes")}," 笔记 ",2),e("button",{class:c(["tab-button",{active:h.value==="bookmarks"}]),onClick:t[3]||(t[3]=o=>h.value="bookmarks")}," 书签 ",2)]),e("div",xe,[h.value==="chapters"?(a(),n("div",Be,[(a(!0),n(L,null,O(r.value.chapters,o=>(a(),n("div",{key:o.id,class:c(["chapter-item",{active:o.id===u.value}]),onClick:w=>R(o.id)},[e("span",Re,l(o.id),1),e("span",Ne,l(o.title),1)],10,Te))),128))])):k("",!0),h.value==="notes"?(a(),n("div",ze,[A.value.length===0?(a(),n("div",De,t[9]||(t[9]=[e("p",null,"暂无笔记",-1)]))):(a(!0),n(L,{key:1},O(A.value,o=>{var w;return a(),n("div",{key:o.id,class:"note-item"},[e("div",Me,[e("span",Ee,l((w=r.value.chapters.find(z=>z.id===o.chapterId))==null?void 0:w.title),1),t[10]||(t[10]=e("button",{class:"delete-button"},"删除",-1))]),e("div",Fe,l(o.selection),1),e("div",Ie,l(o.content),1)])}),128))])):k("",!0),h.value==="bookmarks"?(a(),n("div",Le,[_.value.length===0?(a(),n("div",Oe,t[11]||(t[11]=[e("p",null,"暂无书签",-1)]))):(a(!0),n(L,{key:1},O(_.value,o=>{var w;return a(),n("div",{key:o,class:c(["bookmark-item",{active:o===u.value}]),onClick:z=>R(o)},[t[12]||(t[12]=e("span",{class:"bookmark-icon"},null,-1)),e("span",Ve,l((w=r.value.chapters.find(z=>z.id===o))==null?void 0:w.title),1)],10,Pe)}),128))])):k("",!0)]),e("div",Ae,[e("div",We,[e("span",{class:c(["status-icon",{"status-available":f.value}])},null,2),e("span",null,l(f.value?"已缓存，可离线阅读":"未缓存"),1)]),f.value?(a(),n("button",{key:1,class:"offline-button",onClick:oe},"删除离线缓存")):(a(),n("button",{key:0,class:"offline-button",onClick:se,disabled:B.value},l(B.value?"缓存中...":"下载离线阅读"),9,Xe))])],2),e("div",{class:c(["reading-content",{"sidebar-open":m.value}]),style:K({fontSize:`${E.value}px`}),onTouchstart:le,onTouchend:ie},[e("div",qe,[e("div",He,[e("h2",je,l((v=b.value)==null?void 0:v.title),1)]),e("div",Je,[(y=b.value)!=null&&y.content?(a(),n("p",Ue,l(b.value.content),1)):k("",!0),ee.value&&((N=b.value)!=null&&N.translation)?(a(),n("p",Ye,[t[13]||(t[13]=e("span",{class:"translation-label"},"译文：",-1)),ge(l(b.value.translation),1)])):k("",!0),Z.value&&((S=b.value)!=null&&S.notes)?(a(),n("div",Ge,[t[14]||(t[14]=e("span",{class:"notes-label"},"注释：",-1)),e("p",null,l(b.value.notes),1)])):k("",!0)])]),e("div",Ke,[e("button",{class:"prev-chapter",onClick:H,disabled:u.value===1}," 上一章 ",8,Qe),e("div",Ze,l(u.value)+"/"+l(r.value.chapters.length),1),e("button",{class:"next-chapter",onClick:j,disabled:u.value===r.value.chapters.length}," 下一章 ",8,et)])],38),e("div",{class:c(["bottom-toolbar",{"toolbar-hidden":!V.value}])},[e("div",tt,[e("div",{class:"progress-fill",style:K({width:`${F.value}%`})},null,4)]),e("div",st,[e("button",{class:"toolbar-button",onClick:ae},[e("span",{class:c(["icon",{"icon-scroll":d.value==="page","icon-page":d.value==="scroll"}])},null,2),e("span",ot,l(d.value==="scroll"?"滚动":"翻页"),1)]),e("button",{class:"toolbar-button",onClick:re},[e("span",{class:c(["icon",{"icon-moon":!g.value,"icon-sun":g.value}])},null,2),e("span",nt,l(g.value?"日间":"夜间"),1)]),e("button",{class:"toolbar-button",onClick:t[4]||(t[4]=o=>U(-1))},t[15]||(t[15]=[e("span",{class:"icon icon-font-decrease"},"A-",-1)])),e("button",{class:"toolbar-button",onClick:t[5]||(t[5]=o=>U(1))},t[16]||(t[16]=[e("span",{class:"icon icon-font-increase"},"A+",-1)])),e("button",{class:"toolbar-button",onClick:de},[e("span",{class:c(["icon",{"icon-volume":!C.value,"icon-volume-mute":C.value}])},null,2),t[17]||(t[17]=e("span",{class:"button-label"},"朗读",-1))])])],2),d.value==="page"?(a(),n("div",at,t[18]||(t[18]=[e("div",{class:"hint-left"},"← 上一章",-1),e("div",{class:"hint-right"},"下一章 →",-1)]))):k("",!0)],2)}}}),vt=_e(lt,[["__scopeId","data-v-5e76cd32"]]);export{vt as default};
